<style> 
  body{
    div{
      details{
        summary{
          text-transform: capitalize;;
        }
      }
    }  
  }
  #loading{
    display:none; 
    position:fixed; 
    top:0px; width:100vw; 
    background: orange; 
    color:green; 
    font-size: 30;
  }
  a{
    text-decoration: underline; cursor:pointer
  }
  label{font-weight: bold;}  
  textarea[name=newcompanyRecord] {height:100px; } 
  textarea{max-width: 800px; height:250px; width: -webkit-fill-available; } 
  .sitemapTitle {cursor:pointer; background-color: white;}
  .sitemapDetailForm{margin:2px 0px;}
  .sitemap-detail{
    display: flex;
    p, input[type=checkbox]{
      width: 30px; 
    }
    p{
      width: 40px; 
    }
    input[type=text]{
      cursor: pointer;
      flex-grow: 1;
    }
  }
  button { 
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
  } 
  button[type=update] {
      background-color: blue;
  }
  button[type=scrape], button[type=crawl] { 
      background-color: green; 
  } 
  details {
      max-width:800px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
  }
  details > summary {
      background-color: #ccc;
      padding: 2px 4px;
  } 
 .yellow, details > div > details > summary,
  .jobPosts > details > summary { background: #eec; } /* yellowish */
  summary[name='extractsTitle'],   
  .jobPosts > details > details > summary { background: #cee; } /* blueish */
  summary[name='originalTextTitle'], 
  summary[name='extractedTextTitle'],
  .red  { background: #ecc; } /* redish */
  summary {
      background-color: #eee;
      padding: 2px 4px;
  }
  .toast {
      visibility: hidden;
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #333;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
  }
  .toast.show {
      visibility: visible;
      opacity: 1;
  } 
  .sitemapForm{
    min-height:100px;
    max-height: 350px;
    overflow: auto;
  } 
  .sitemap-detail > p{
    transform: rotate(-36deg);
    transform-origin: center;
  }  
  .toggle-visibility + label:after {
    content: 'Add';
    cursor:pointer;
    text-decoration: underline;
    text-decoration-color: blue;
  }
  .toggle-visibility:checked + label {
    display: none;
  } 
  .toggle-visibility + label + label > .details-textbox {
      display: none; 
  }
  .toggle-visibility:checked + label + label > .details-textbox {
      display: block;
  } 
  .dialog-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      display: none; 
      justify-content: center;
      align-items: center;
    }
    .dialog-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 80%;
      max-width: 600px;
    }
    .close-button {
      float: right;
      padding: 2px 5px;
      cursor: pointer;
    } 
    .jobTitleContainer div {
      display: inline-flex;
      width: calc(100% - 18px);
      justify-content: space-between;
    } 
    .jobTitleContainer button {
      background:red;
      color:white; 
      border:none; 
      cursor:pointer;
      padding:0px;
    }

    .resumeContent, .coverLetterContent, .emailContent { display: none; }
  #tab1:checked ~ .resumeContent, 
  #tab2:checked ~ .coverLetterContent, 
  #tab3:checked ~ .emailContent { display: block; } 
</style>
<h1>Settings</h1>
<div id="loading">Running Requested Task...</div>

<!-- Update Bio -->
<details id="bioContainer"> <summary><h2 style="display:contents">User Bio</h2></summary> 
  <form>
      <label for="updateBio">Your Bio:</label><br>
      <textarea id="updateBio" name="updateBio"></textarea><br>
      <button type="scrape">Update Bio</button>
  </form>
</details>

<!-- Resources Template -->
<!--
  Onstart display with Resume content then updated to do it again for Email and CoverLetter
-->

<template id="userInfoTemplate">
  <details> <summary><h2 style="display:contents">replaceThis</h2></summary> 
    <p>
    Copy and paste your document here. The LLM will use it as a template in the redraft<br/>
    </p> 
    <details><summary class="yellow">Upload replaceThis</summary>
      <form>
        <input type="hidden" name="type" value="replaceThis">
        <input type="hidden" name="messageOrTemplate" value="template">
        <label> Name: </label><input type="text" name="replaceThisName" placeholder="Template Name..."><br>
        <textarea name="replaceThis" placeholder="Enter replaceThis here:"></textarea>
        <button type="scrape">Upload replaceThis</button> 
      </form>
    </details>
    <details> 
      <summary  class='yellow' name='templates'>Uploaded replaceThiss</summary> 
      <div id="replaceThisUploadedTemplates"></div>
    </details>
    <p>
    Add specific processing instructions for the LLM here.<br/>
    </p>
    <details><summary class="yellow">Upload Message</summary>
      <form>
        <input type="hidden" name="type" value="replaceThis">
        <input type="hidden" name="messageOrTemplate" value="message">
        <label> Name: </label><input type="text" name="messageName" placeholder="Message Name..."><br>
        <textarea name="message"  placeholder="Enter message here:"></textarea>
        <button type="scrape">Upload Message</button> 
      </form>
    </details>
    <details> 
      <summary class='yellow' name='messages'>Uploaded Messages</summary> 
      <div id="replaceThisUploadedMessages"></div>
    </details>
  </details>
</template> 

<!-- Display and Update Resume Template -->
<template id="userinfoUpdateTemplate">
  <details> <summary class="red"> Dynamically Overwritten </summary>
    <form> 
      <div style='display:flex; justify-content: flex-end;'> <button style='background:red;color:white' name='remove'>Delete</button> </div>
      <input type="hidden" name="userinfo_id">
      <textarea name="replaceThis" >Content Here</textarea>      
      <div style='display:flex; justify-content: flex-end;justify-content: space-around;'> 
        <button style='background:blue;color:white' name='update'>Update</button> 
        <div></div>
      </div>
    </form>
  </details>
</template>

<!-- Upload Post -->
<details> <summary><h2 style="display:contents">Upload Job Post</h2></summary> 
  <form>
      <label for="newcompanyRecord">New company Record:</label><br>
      <textarea id="newcompanyRecord" name="newcompanyRecord" ></textarea><br>
      <button type="scrape" onclick="createCompany(event);">Add company Post</button>
  </form>
</details>

<h1>Company Records <small>(Newest -> Oldest)</small></h1>

<div id="rowsPlaceholder">{{rowsContent}}</div>

<div id="toast" class="toast">Success!</div> 

<!-- Company Template -->
<template id="companyTemplate">  <!-- populateCompany(contentDiv, details){ let {companyDetails, posts, sitemapDetails} = details; -->
  <div>
    <h3 style="display: inline;">Details</h3>
    <hr/>
    <button onclick="showDialog1()">Help</button>
    <div class="dialog-background" id="dialogBackground1">
      <div class="dialog-content">
        <span class="close-button" onclick="closeDialog()">&times;</span>
        <p>
          <b>1.</b> Set the status marker (🟨,🟥,🟩,🟦,🟧,🟪,🟫,⬛,⬜) as you see fit <br/>
          Possible color coding:
          🟨=unseen, 🟥=bad, 🟩=good, 🟦=applied, 🟧=outOfDate, 🟪=applied-but-multiple-available, ⬛=rejected
          <b>2.</b> Ensure the websiteUrl is correct. It is used to retrieve sitemap information in the next step. <br/> 
          </p>
      </div>
    </div>
    <script>
      function showDialog1() {
        document.getElementById('dialogBackground1').style.display = 'flex';
      }    
      function closeDialog() {
        var dialogs = document.getElementsByClassName('dialog-background');
        for (var i = 0; i < dialogs.length; i++) {
          dialogs[i].style.display = 'none';
        }
      }
    </script>
    <form>
      <input type="hidden" name="company_id"> 
      <label> Status: <input type="number" name="status"> </label> <br>
      <label> Website URL: <input type="text" name="websiteUrl"> </label> 
      <a onclick="window.open(this.previousElementSibling.children[0].value, '_blank')">(Visit)</a> <br>
      <!-- <div style='display:flex;flex-direction: row;justify-content: space-around;align-items: flex-start;'> -->
      <button type="update"   onclick="updatecompanyRecord(event);">Save Changes</button>
    </form> 
    <details>
      <!-- <summary class="sitemapTitle"><h3 style="display: inline;">Sitemap</h3></summary> 
      -->
      <summary class="sitemapTitle">Sitemap</summary>
      <hr/>
      <button onclick="showDialog2()">Help</button>
      <div class="dialog-background" id="dialogBackground2">
        <div class="dialog-content">
          <span class="close-button" onclick="closeDialog()">&times;</span>
          <p>
            The AI will use links below to help generate your applications. <br/>
            <b>Generic</b> links are used for all applications <br/>
            <b>Specific</b> links are set here and toggled for use on a per-applications-basis in the next step.<br/>
            <b>Board</b> links are auto-scrapped/crawled to get job posts.
          </p>
          <p> 
            Populating links:<br/>
            <b>1.</b> This service makes a quick attempt to get website links when first added. <br/> 
            <b>2.</b> Anytime after hitting 'Save Changes', hit 'Crawl Website URL Url' to perform a more dedicated scan of the website for links. This can take a moment. <br/>
            <b>OR 3.</b> Entering links manually below.
          </p> 
        </div>
      </div>
      <script>
        function showDialog2() {
          document.getElementById('dialogBackground2').style.display = 'flex';
        }
      </script>
      
      <form class="newsitemapRecord">   
        <input type="hidden" name="company_id"> <!--Update value-->
        <div class="sitemap-detail">
          <p><strong>Generic</strong></p> 
          <p><strong>Specific</strong></p> 
          <p><strong>Board</strong></p> 
          <p><strong>Link</strong></p>
        </div>
        <div class="sitemap-detail">
          <input type="checkbox" name="generic"> </input>
          <input type="checkbox" name="specific"> </input>
          <input type="checkbox" name="board"> </input>
          <input type="text" name="link" value="" placeholder="https://www.example.com" style='cursor: auto;'> </input>
          <button type="scrape" onclick="createSitemapRecord(event);" style='padding:3px;'>Add Link</button>
        </div>  
      </form>
      <div class="sitemapForm">  
        <div class="sitemap-detail">
          <p><strong>Generic</strong></p> 
          <p><strong>Specific</strong></p> 
          <p><strong>Board</strong></p> 
          <p><strong>Link</strong></p>
        </div>
        <div class="siteLinkOptions"></div> <!-- sitelinkOptionsTemplate -->
      </div>  
      <form>
        <input type="hidden" name="company_id"> 
        <button type="crawl" onclick="event.preventDefault(event); sitemapFetch(event);">Fetch Sitemap</button>
        <button type="crawl" onclick="event.preventDefault(event); sitemapCrawl(event);">Crawl Website URL</button>   
        <button type="crawl" onclick="event.preventDefault(event); sitemapCrawlBoardLinks(event);">Search Jobs Board(s)</button>
        <!-- <button type="crawl" onclick="event.preventDefault(event); sitemapScrapeGenericSpecificLinks(event)">Update Text</button>  -->
      </form>  
    </details> 
    <h3 style="display:inline"> Jobs</h3>
    <button onclick="showDialog3()">Help</button> 
    <hr/>
    <div class="dialog-background" id="dialogBackground3">
      <div class="dialog-content">
        <span class="close-button" onclick="closeDialog()">&times;</span>
        <p>Select links above then hit 'Generate Details' and then update the extracted details here.</p>
      </div>
    </div>
    <script>function showDialog3() {document.getElementById('dialogBackground3').style.display = 'flex';}</script> 
    <div class="jobPosts"> </div> <!-- opulatePosts() -> jobTemplate -->
  </div>
</template>

<!-- Sitelink Template -->
<template id="sitelinkOptionsTemplate">
  <form class="sitemapDetailForm">
    <div class="sitemap-detail">
      <input type="hidden" name="company_id"> <!--Update value-->
      <input type="checkbox" onchange="updateSitemapRecords(event);"> </input>
      <input type="checkbox" onchange="updateSitemapRecords(event);"> </input>
      <input type="checkbox" onchange="updateSitemapRecords(event);"> </input>
      <input type="text" readonly> </input>
      <button type="button" style='background:red;color:white;padding:3px;' onclick="deleteForm(event);">Delete</button>
      <hr/>
    </div>
  </form>
</template>
 

<!-- Job Template (+Resume content) -->
<template id="jobTemplate">
  <details>
    <summary class="jobTitleContainer">
      <div>
        <div>
          <div name="jobPostIdDisplay" style="width: fit-content;"></div>
          <div name="jobStatusDisplay" style="width: fit-content;"></div>
          <div name="jobTitle"></div>
          <div style="width:auto;"> 
            <div name="jobRemote" style="padding-right: 8px;"></div>
            <div name="jobEmail" style="padding-right: 8px;"></div>
          </div>
        </div>
        <button name="rmPost">Delete</button>
      </div>
    </summary>

    <form>
      <input type="hidden" name="company_id"> 
      <input type="hidden" name="post_id"> 
      <input type="hidden" name="force" value="on"> 
      <button type="crawl" onclick="event.preventDefault(event); generateDetailsForPost(event);">Generate Details</button>  <br/>
      <label for="jobStatus">Status:</label><input type="number" onchange="event.preventDefault(event); updatePostStatus(event);" name="jobStatus" value="0">
    </form>
    
    <!-- Extracts Template -->
    <div name="extractsContainer">Click 'Generate Details'...</div>

    <!-- Resume Cover Letter Email-->
    <details> <summary><h3 style="display: inline;">Resume</h3></summary>
      <hr/>
      <form>
        <input type="hidden" name="company_id"> <!-- Update value-->
        <input type="hidden" name="post_id"> <!-- Update value--> 
        
        <a name="applicationUrlVal" target="_blank"></a> <br/> 
        <p name="supplementalUrls"> </p>
        <p name="instructionsToApplicant"> </p>  
 
        <div style="border: 2px solid black; background: rgba(0, 0, 0, 0.1)">
          <!-- Tab Controls --> 
          <input type="radio" id="tab1" name="tab-control" checked>
          <label for="tab1">Resume</label>
          <input type="radio" id="tab2" name="tab-control">
          <label for="tab2">Cover Letter</label>
          <input type="radio" id="tab3" name="tab-control">
          <label for="tab3">Email</label> 
          <br/>
          
          <input type="checkbox" name="resubmit"> Resubmit for corrections </input> <br/> 
          <input type="checkbox" name="gpt4" checked> use GPT4 </input> <br/> 
        
          <hr/>
          <!-- Tab Content --> 
          <div class="resumeContent">   
            <label for="resume_id">Use Resume:</label> <select name="resume_id"> Dropdown Options</select> <br/> 
            <label for="messageResume">User Message:</label> <select name="resume_message_id"> Dropdown Options</select> <br/>              
            <textarea name="messageResume"  style="height:50px;" placeholder='Enter a resume prompt here'></textarea> 
            <button type='crawl' name="generateResume">Create Resume</button> <br/>
            <b>Pdf Text:</b><br/>
            <textarea name="newResume"  style="height:50px;" placeholder='Generated Resume Content Here'></textarea>
            <button name="refreshResume" type="crawl" style="display:none;">Refresh PDF</button> 
            <button name="downloadResume" type="crawl" style="display:none;">Download Resume</button>   
            <iframe name="previewResume" style="display:none; width:700px;" src="" width="100%" height="100%"></iframe> 
          </div>
          <div class="coverLetterContent">
            <label for="coverLetter_id">Use Cover Letter:</label> <select name="coverLetter_id"> Dropdown Options</select> <br/> 
            <label for="messageCoverLetter">User Message:</label> <select name="coverLetter_message_id"> Dropdown Options</select> <br/>
            <textarea name="messageCoverLetter"  style="height:50px;" placeholder='Enter a cover letter prompt here'></textarea> 
            <button type="crawl" name="generateCoverLetter">Create Cover Letter</button> <br/>  
            <b>Pdf Text:</b><br/> 
            <textarea name="newCoverLetter"  style="height:50px;" placeholder='Generated Cover Letter Content Here'></textarea> 
            <button name="refreshCoverLetter" type="crawl" style="display:none">Refresh</button>
            <button name="downloadCoverLetter" type="crawl" style="display:none;">Download Cover Letter</button>
            <iframe name="previewCoverLetter" style="display:none; width:700px;" src="" width="100%" height="100%"></iframe>
          </div>
          <div class="emailContent">
            <label for="emailApplicationTo">Email To:</label>
            <input name="emailApplicationTo" placeholder='Enter email to: '/> <br/> 
            <label for="emailApplicationSubjectLine">Email Subjet Header:</label>
            <input name="emailApplicationSubjectLine" placeholder='Enter email subject: '/> <br/> 
            <label for="email_id">User Email Template:</label> <select name="email_id"> Dropdown Options</select> <br/> 
            <label for="messageEmail">User Message:</label> <select name="email_message_id"> Dropdown Options</select> <br/>
            <textarea name="messageEmail"  style="height:50px;" placeholder='Enter a email prompt here'></textarea> <br/>     
            <button type="crawl" name="CreateEmail" onclick="event.preventDefault(event); generateEmail(event);">Create Email</button> <br/>  
            <textarea name="newEmail"  style="height:50px;" placeholder='Generated Email Content Here'></textarea>   
            <button type="crawl" name="emailSend" onclick="event.preventDefault(event); sendEmail(event);">Send Email</button> 
          </div> 
        </div>
 
      </form>
    </details>
  </details>
</template>

<template id="extractsTemplate"> 
  <details>
    <summary name="extractsTitle"></summary> 
    <form> 
      <input type="hidden" name="extract_id"> 
      <label>Obtained From:</label><input type="text" name="fromUrlLbl"> </input><br/>
      <label><input type="checkbox" name='toggleUse'> Use entry for resume</label><br/>
      <button type="update" onclick="event.preventDefault(event); updateDetails(event)">Save Changes</button> 
      <button type="update" onclick="event.preventDefault(event); generateDetailForPost(event)">Re-Fetch Details</button> 
      <details>
        <summary name="originalTextTitle">Original Text</summary> 
        <details><summary>Edit</summary><textarea style="width:100%;" name="originalText"></textarea></details>
        <div style="white-space: pre-wrap;" name="displayText"></div> 
      </details> 
      <details><summary name="extractedTextTitle"> Extracted Details </summary> 
        <div name='detailsContent'>
          <!-- Populated Dynamically -->
        </div>
      </details>  
    </form>
  </details> 
</template>

<script type="module"> 
import {route} from './../extension/router.js'; // express will serve this correctly

 
//~~~~~~ Overview

  // On companyContainer Click
  // Uses companyTemplate
  // calls opulatePosts, opulateSitemap
  function populateCompany(contentDiv, details){ 
    let {companyDetails, posts} = details; // sitemapDetails 
    let {id, websiteUrl, status} = companyDetails[0];
    console.log('populateCompany', {companyDetails, posts, id, websiteUrl, status})

    const template = document.getElementById('companyTemplate').content.cloneNode(true);
    template.querySelectorAll('[name="company_id"]').forEach(el => el.value = id);
    template.querySelector('[name="websiteUrl"]').value = websiteUrl;
    template.querySelector('[name="status"]').value = status; 
    const sitemapTitleElement = template.querySelectorAll('summary'); 
    template.querySelector('.sitemapTitle').addEventListener('click', async (el) =>{
      console.log('.sitemapTitle clicked: ', id)
      let sitemapDetails = await route({"company_id":id}, '/sitemap/') 
      populateSitemap(sitemapDetails)
    });
    populatePosts(template, posts)
    contentDiv.innerHTML = '';
    contentDiv.appendChild(template);
}
  
  function updatecompanyRecord(event) { route(event, '/company-update/', (data) => {
      let status = document.getElementById('detail-' + data.params.company_id).querySelector('.status');
      let colors = '🟨,🟥,🟩,🟦,🟧,🟪,🟫,⬛,⬜'.split(',')
      status.innerHTML = '🟨,🟥,🟩,🟦,🟧,🟪,🟫,⬛,⬜'.split(',')[data.params.status] 
    });
  }

//~~~~~~ Sitemap

  function sitemapCrawl(event) {route(event, '/sitemap-crawl/', populateSitemap ) } 
  
  function sitemapFetch(event) {route(event, '/sitemap-fetch/', populateSitemap ) } 
  
  function populateSitemap(sitemapDetails){  
    console.log('populateSitemap', sitemapDetails.length, {sitemapDetails})
    const links = sitemapDetails.links || sitemapDetails
    if(!links.length) return;
    const company_id = links[0].company_id; 
    
    const container = document.getElementById('detail-'+company_id); 
    const newsitemapRecord = container.querySelector('.newsitemapRecord'); // add a new link 
    const sitemapForm = container.querySelector('.sitemapForm');           // update existing links 
    const detailsElement = container.parentElement
    detailsElement.open = true; 

    let siteLinkOptions = sitemapForm.querySelector('.siteLinkOptions');
    siteLinkOptions.innerHTML = ''; 

    links.forEach(detail => {
      const sloTemplate = document.getElementById('sitelinkOptionsTemplate').content.cloneNode(true);
      const inputs = sloTemplate.querySelectorAll('input'); 
      inputs[1].name = 'generic_' + detail.id;
      inputs[2].name = 'specific_' + detail.id;
      inputs[3].name = 'board_' + detail.id;
      inputs[4].name = 'link_' + detail.id;

      inputs[1].checked = detail.generic == 1;
      inputs[2].checked = detail.specific == 1;
      inputs[3].checked = detail.board == 1;
      inputs[4].value = detail.link;   
      inputs[4].onclick = () => window.open(detail.link, '_blank');
      sloTemplate.querySelector('button').onclick= () => {rmlink(company_id, detail.id)}
      siteLinkOptions.appendChild(sloTemplate);
    }); 

    const companyIDElements = container.querySelectorAll('[name="company_id"]');
    companyIDElements.forEach(element => { element.value = company_id; }); 

    // Create and insert the filter textbox
    let filterInput = container.querySelector('.filter-input');
    if(filterInput){filterInput.value = '';}
    else {
        filterInput = document.createElement('input');
        filterInput.setAttribute('type', 'text');
        filterInput.setAttribute('placeholder', 'Filter...');
        filterInput.className = 'filter-input';
        siteLinkOptions.before(filterInput); // Insert before siteLinkOptions

        filterInput.addEventListener('keyup', function() {
          const value = this.value.toLowerCase();
          // Select all forms within the siteLinkOptions container
          const forms = siteLinkOptions.querySelectorAll('.sitemapDetailForm');

          forms.forEach(form => {
            // Find the link input within the form, assuming it's the one with type="text"
            const linkInput = form.querySelector('input[type="text"]');
            if (linkInput && linkInput.value.toLowerCase().includes(value)) {
              form.style.display = ''; // Show the form if the input value matches
            } else {
              form.style.display = 'none'; // Hide the form if the input value does not match
            }
          });
        });
      }
  }

  function createSitemapRecord(event) {route(event, '/sitemap-create-link/', (data)=>{ populateSitemap(data) }  )}

  function rmlink(company_id, id) { route({id}, '/sitemap-remove-link/', (data) => { 
      let contentDiv = document.getElementById('content-' + company_id); 
      let btn = contentDiv.querySelector('input[type="checkbox"][name="generic_' + id + '"]') 
      btn.parentElement.remove(); 
    })
  } 

  function updateSitemapRecords(event) { route(event, '/sitemap-update-link/', populateSitemap ) } 

//~~~~~~ Posts

  function createCompany(event) { route(event, '/post_create/', (data)=>{window.location.reload()} ) } 

  // calls populateJobDetails, contains resume, no extract info but sets handler for it
  async function populatePosts(container, posts){  
    container.querySelector('.jobPosts').innerHTML = ''; 
    posts.map( (post) => { 
      let meta = JSON.parse(post.meta)
      console.log({post, meta})
      const jobTemplate = document.getElementById('jobTemplate').content.cloneNode(true); 
      jobTemplate.querySelector('[name="company_id"]').value = post.company_id;
      jobTemplate.querySelector('[name="post_id"]').value = post.id;
      jobTemplate.querySelector('details').id=`post-${post.company_id}-${post.id}`
      jobTemplate.querySelector('[name="jobTitle"]').innerHTML = `${post.jobTitle}`;  
      jobTemplate.querySelector('[name="jobRemote"]').innerHTML = `${meta.remoteAvailable?.length?'🌐':''}`;  
      jobTemplate.querySelector('[name="jobEmail"]').innerHTML = `${meta.emailApplicationTo?.length?`📧`:''}`;  
      jobTemplate.querySelector('[name="jobPostIdDisplay"]').innerHTML = `${post.id} `;
      jobTemplate.querySelector('[name="jobStatusDisplay"]').innerHTML = '🟨,🟥,🟩,🟦,🟧,🟪,🟫,⬛,⬜'.split(',')[post.status]
      jobTemplate.querySelector('summary').onclick = async (el) => {  
        let postData = await fetch('/post_view/' + post.id).then(res => res.json()) 
        populatePost(postData)
      }
      container.querySelector('.jobPosts').appendChild(jobTemplate);
    })
  }

  async function populatePost(post){ 
      console.log('populatePost')
      let meta = JSON.parse(post.meta); 
      console.log({post, meta})  
      let postContainer = document.querySelector(`#post-${post.company_id}-${post.id}`)
      postContainer.querySelector('[name="jobStatus"]').value = post.status;  
      postContainer.querySelector('[name="jobRemote"]').innerHTML = !!(meta.remoteAvailable||meta.isRemote)?.length ? `🌐` : ''; 
      postContainer.querySelector('[name="rmPost"]').value = `${post.company_id}_${post.id}`;
      postContainer.querySelector('[name="rmPost"]').onclick = () => {rmpost(post.company_id, post.id)} 

      // Application
      postContainer.querySelectorAll('[name="company_id"]').forEach(el => el.value = post.company_id); 
      postContainer.querySelectorAll('[name="post_id"]').forEach(el => el.value = post.id);  

      // Links
      appUrl = postContainer.querySelector('[name="applicationUrlVal"]'); meta.applicationUrl && ((appUrl.innerHTML = 'Visit Application'), (appUrl.href = meta.applicationUrl)); 
      postContainer.querySelector('[name="supplementalUrls"]').innerHTML = "<b>Supplemental Urls: </b>" + meta.supplementalUrls||''; 
      postContainer.querySelector('[name="instructionsToApplicant"]').innerHTML = "<b>Instructions to Applicant: </b>" + (meta.instructionsToApplicant||'');  
 
      //todo: merge this repeat logic 
      createApplicationPanel(postContainer, meta);

      const extracts = (await (await fetch('/extracts-view-for-post/' + post.company_id + '_'+ post.id)).json()).extracts  
      populateJobDetails(extracts)

      let newResume = postContainer.querySelector('[name="newResume"]');
      if(post.resume && newResume?.value == ''){  
        displayResume({company_id:post.company_id, post_id:post.id, newResume: post.resume, useSaved: true}) 
      }

      let newCoverLetter = postContainer.querySelector('[name="newCoverLetter"]');
      if(post.coverLetter && newCoverLetter?.value == ''){  
        displayCoverLetter({company_id:post.company_id, post_id:post.id, newCoverLetter: post.coverLetter, useSaved: true}) 
      }
  }

  function rmpost(company_id, id) { route({id}, '/post-remove/', (data) => { 
      let contentDiv = document.getElementById('post-' + company_id+'-'+id); 
      contentDiv.remove();
    })
  } 
  
  function sitemapCrawlBoardLinks(event) {route(event, '/sitemap-crawl-board-links/', (data)=>{ 
    let id = `detail-${data.posts[0].company_id}`
    let container = document.getElementById(id)
    console.log('sitemapCrawlBoardLinks', data, data.posts[0], container)
    populatePosts(container, data.posts) 
  }) } 

  // function sitemapScrapeGenericSpecificLinks(event) {route(event, '/retrieve-generic-specific-links/', (data)=>{ }) } 
  // function updatePostSpecificLink(id) { route(id, '/update-post-specific-link/', (data) => { }) }  
  // function generateDetails(event) {route(event, '/extracts-create/', (data)=>{ populateJobDetails(data.extracts) }) }
  function updatePostStatus(event) { route(event, '/post-update-status/', (resp) => { 
    let {company_id, post_id, status} = resp.data;
    // console.log('updatePostStatus', {resp:resp.data, company_id, post_id, status})
    let container = document.getElementById(`post-${company_id}-${post_id}`).querySelector('[name="jobStatusDisplay"]').innerHTML = '🟨,🟥,🟩,🟦,🟧,🟪,🟫,⬛,⬜'.split(',')[status]
   }) }
  function generateDetailsForPost(event) {route(event, '/extracts-create-for-post/', (data)=>{ populateJobDetails(data.extracts) }) }
  function generateDetailForPost(event) {route(event, '/extract-create-for-post/', (data)=>{ populateJobDetails(data.extracts) }) }
   
  // opulatePosts() sets .jobtitleContainer onclick to call this
  function populateJobDetails(extracts) { 
    if (!extracts.length) return;
    let company_id = extracts[0].company_id; 

    let post_id = extracts[0].post_id;
    let container = document.getElementById(`post-${company_id}-${post_id}`) 
    container = container.querySelector('[name="extractsContainer"]');
    container.innerHTML = '';
    extracts.forEach(extractObj => { 
      const parsedExtract = JSON.parse(extractObj.extract); 
      console.log('populateJobDetails - parsedExtract - ', `post-${company_id}-${post_id}`, {extractObj, parsedExtract})
      const color = extractObj.status ? '🟩' : '🟥'; 
      // hide obtained from if sitemap_id == 0 
      const template = document.getElementById('extractsTemplate').content.cloneNode(true);
      extractObj.sitemap_id == 0 && (template.querySelector('[name="fromUrlLbl"]').style.display = 'none');
      const title = `${color} ${extractObj.type} ` // + (extractObj.sitemap_id == 0 ? "" : extractObj.link);
      template.querySelector('[name="extractsTitle"]').innerHTML = title;
      template.querySelector('[name="extract_id"]').value = extractObj.id;
      template.querySelector('[name="fromUrlLbl"]').value = extractObj.link;
      template.querySelector('[name="originalText"]').innerHTML = extractObj.text;
      template.querySelector('[name="displayText"]').innerHTML = extractObj.text; 
      
      // Status checkbox
      let checked = extractObj.status ? 'checked' : '';
      
      // set checked on toggleUse
      template.querySelector('[name="toggleUse"]').checked = extractObj.status;  

      // Details content
      let detailsContentHTML = Object.keys(parsedExtract).map(key => {
        if (['id', 'sitemap_id', 'company_id', 'post_id', 'type', 'dateAdded', 'link'].includes(key)) return ''; 
        let values = parsedExtract[key];
        let toggleBtn = values.length === 0 ? `
          <input type="checkbox" id="toggle-${post_id}-${key}" class="toggle-visibility" style="display:none;">
          <label for="toggle-${post_id}-${key}"></label>` : '';
        let formattedValues = values.join('\n').replace(/^\[/, '').replace(/\]$/, '');
        let numRows = Math.max(values.length, 1);
        function capitalize(str) {return str.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');}
        return `${toggleBtn} <label>${capitalize(key)}: 
          <textarea name="${key}" rows="${numRows}" class="details-textbox" style="height:auto;width:-webkit-fill-available;">${formattedValues}</textarea>
        </label><br/>`;
      }).join('');

      template.querySelector('[name="detailsContent"]').innerHTML = detailsContentHTML;
      container.append(template);
    }); 
}

  function updateDetails(event) { route(event, '/extract-update/', (data) => { 
    let container = event.target.parentElement.parentElement 
    let title = container.querySelector('[name="extractsTitle"]') 

    console.log(container, title, data) 
    title.innerHTML = data.extract.status ? title.innerHTML.replace('🟥', '🟩') : title.innerHTML.replace('🟩', '🟥')
  }) } 

//~~~~~~ Resume

// todo : merge w generateCoverLetter
async function generateResume(event) {
  console.log('generateResume - sending: ');
  let startTime = new Date().getTime();
  let data = await route(event, '/resume-generate/') 
  let endTime = new Date().getTime();
  let lapse = endTime - startTime;
  let lapseInSeconds = (lapse / 1000).toFixed(2);
  displayResume(data.payload);
}

async function generateCoverLetter(event) { 
  console.log('generateCoverLetter - sending: ');
  let startTime = new Date().getTime(); 
  let data = await route(event, '/cover-letter-generate/')
  let endTime = new Date().getTime();
  let lapse = endTime - startTime;
  let lapseInSeconds = (lapse / 1000).toFixed(2);
  console.log('generateCoverLetter - received: ', lapseInSeconds );
  displayCoverLetter(data.payload);
} 

// todo : merge w displayResumePdf
async function displayResume(body){
  console.log('displayResume', body)
  let jobPostContainer = document.getElementById(`post-${body.company_id}-${body.post_id}`)

  // Display the text
  let resumeText = jobPostContainer.querySelector('[name="newResume"]')
  resumeText.value = body.newResume;
 
  // Display the PDF
  displayResumePdf(body); 
  body.useSaved = false;

  // Event Listener - Refresh 
  let refreshResume = jobPostContainer.querySelector('[name="refreshResume"]'); 
  refreshResume.style.display = 'inline-block';
  refreshResume.onclick = async (event) => { 
    event.preventDefault();
    event.preventDefault(event);  
    body.newResume = resumeText.value; 
    displayResumePdf(body)
  };   

  // Event Listener - Download
  let downloadResume = jobPostContainer.querySelector('[name="downloadResume"]'); 
  downloadResume.style.display = 'inline-block';
  downloadResume.onclick = (event) => {
    event.preventDefault();
    event.preventDefault(event);  
    downloadResumePdf(body)
  };
}

async function displayCoverLetter(body){
  console.log('generateCoverLetter', body); 
  let jobPostContainer = document.getElementById(`post-${body.company_id}-${body.post_id}`)

  // Display the text 
  console.log('coverLetterText', body)
  let coverLetterText = jobPostContainer.querySelector('[name="newCoverLetter"]')  
  coverLetterText.value = body.newCoverLetter; 
      
  // Display the PDF
  displayCoverLetterPdf(body)

  // Event Listener - Refresh
  let refreshCoverLetter = jobPostContainer.querySelector('[name="refreshCoverLetter"]'); 
  refreshCoverLetter.style.display = 'inline-block';
  refreshCoverLetter.onclick = async (event) => { 
    console.log('refreshCoverLetter', event)
    event.preventDefault();
    event.preventDefault(event);
    body.newCoverLetter = coverLetterText.value; 
    displayCoverLetterPdf(body) 
  }; 
  
  // Event Listener - Download
  let downloadCoverLetter = jobPostContainer.querySelector('[name="downloadCoverLetter"]'); 
  downloadCoverLetter.style.display = 'inline-block';
  downloadCoverLetter.onclick = (event) => {
    event.preventDefault();
    event.preventDefault(event);  
    downloadCoverLetterPdf(body) 
  }; 
}

// todo : merge w downloadCoverLetterPdf
function downloadResumePdf( body ){ 
  let {company_id, post_id} = body;
  let jobPostContainer = document.getElementById(`post-${company_id}-${post_id}`)

  // Get the name of the company and the job title stored in the html 
  let companyContainer = document.getElementById(`detail-${company_id}`)
  let titleElement = companyContainer.querySelector('summary').cloneNode(true); 
  titleElement.querySelector('.status').remove();
  let companyName = titleElement.innerText.substring(titleElement.innerText.indexOf(':') + 1).trim(); 
  let jobTitle = jobPostContainer.querySelector('summary').querySelector('[name="jobTitle"]').innerText;
  let lbl = `Resume-${window.name}-${companyName}-${jobTitle}.pdf`.replace(/ /g, '');
  console.log({lbl, companyName, jobTitle});

  const a = document.createElement('a');
  a.href = jobPostContainer.querySelector('[name="previewResume"]').src; 
  a.target = '_blank'
  a.download = lbl;
  a.click();
} 

function downloadCoverLetterPdf( body ){ 
  let {company_id, post_id} = body;
  let jobPostContainer = document.getElementById(`post-${company_id}-${post_id}`)

  // Get the name of the company and the job title stored in the html 
  let companyContainer = document.getElementById(`detail-${company_id}`)
  let titleElement = companyContainer.querySelector('summary').cloneNode(true); 
  titleElement.querySelector('.status').remove();
  let companyName = titleElement.innerText.substring(titleElement.innerText.indexOf(':') + 1).trim(); 
  let jobTitle = jobPostContainer.querySelector('summary').querySelector('[name="jobTitle"]').innerText;
  console.log({companyName, jobTitle, companyName});

  const a = document.createElement('a');
  a.href = jobPostContainer.querySelector('[name="previewCoverLetter"]').src;
  a.target = '_blank';
  a.download = `CoverLetter-${windo}-${companyName}-${jobTitle}.pdf`;
  a.click();
}

// todo : merge w displayCoverLetterPdf
async function displayResumePdf(body){  
  let jobPostContainer = document.getElementById(`post-${body.company_id}-${body.post_id}`)
  let previewResume = jobPostContainer.querySelector('[name="previewResume"]'); 

  // Fetch the blob, create the URL 
  let response = await fetch('/resume-generate-pdf', {
    method: 'POST', headers: { 'Content-Type': 'application/json', },
    body: JSON.stringify(body)  }); 
  if (!response.ok) throw new Error('Network response was not ok.');  

  const blob = await response.blob(); 
  const pdfUrl = URL.createObjectURL(blob);  
  previewResume.style.display = 'inline-block';
  previewResume.src = pdfUrl;
}

async function displayCoverLetterPdf(body){
  let jobPostContainer = document.getElementById(`post-${body.company_id}-${body.post_id}`)
  let previewCoverLetter = jobPostContainer.querySelector('[name="previewCoverLetter"]');

  // Fetch the blob, create the URL
  let response = await fetch('/cover-letter-generate-pdf', {
    method: 'POST', headers: { 'Content-Type': 'application/json', },
    body: JSON.stringify(body)  });
  if (!response.ok) throw new Error('Network response was not ok.');

  const blob = await response.blob();
  const pdfUrl = URL.createObjectURL(blob);
  previewCoverLetter.style.display = 'inline-block';
  previewCoverLetter.src = pdfUrl;
}


async function generateEmail(event) { 
  let data = (await route(event, '/email-generate/')).payload
  console.log('generateEmail', data);
  let {company_id, post_id, resume_id, newEmail} = data; 
  document.getElementById('post-' + company_id + '-' + post_id).querySelector('[name="newEmail"]').value = newEmail;
}
 
function sendEmail(event) { route(event, '/email-send/')  }

function apply(event) { route(event, '/apply/')  }

// Create the resume, cover letter, and email panes at the top. 
( async () => {    
    const sortDefaultFirst = (a, b) => a.title.toLowerCase() === 'default' ? -1 : b.title.toLowerCase() === 'default' ? 1 : a.title.localeCompare(b.title);
     
    let createUpload = (type) => { 
      let container = document.createElement('div');
      let template = document.getElementById('userInfoTemplate').content.cloneNode(true)   
      let htmlString = template.firstElementChild.outerHTML.replace(/replaceThis/g, type); 
      container.innerHTML = htmlString
      document.getElementById('bioContainer').insertAdjacentElement('afterend', container)
    }

    window.resumes = (await (await fetch('/userinfo_view/resume')).json()).data  
    window.resumes = window.resumes.sort(sortDefaultFirst);

    window.resumeMessages = (await (await fetch('/userinfo_view/resume_message')).json()).data   
    window.resumeMessages = window.resumeMessages.sort(sortDefaultFirst);
    createUpload('resume'); 

    window.coverLetters = (await (await fetch('/userinfo_view/coverLetter')).json()).data  
    window.coverLetters = window.coverLetters.sort(sortDefaultFirst); 
    
    window.coverLetterMessages = (await (await fetch('/userinfo_view/coverLetter_message')).json()).data  
    window.coverLetterMessages = window.coverLetterMessages.sort(sortDefaultFirst);
    createUpload('coverLetter'); 

    window.emails = (await (await fetch('/userinfo_view/email')).json()).data   
    window.emails = window.emails.sort(sortDefaultFirst);

    window.emailMessages = (await (await fetch('/userinfo_view/email_message')).json()).data  
    window.emailMessages = window.emailMessages.sort(sortDefaultFirst); 
    createUpload('email');

    console.log('userInfo: ', { 
      resumes : window.resumes, 
      coverLetters : window.coverLetters, 
      emails : window.emails,
      resumeMessages : window.resumeMessages,   
      coverLetterMessages : window.coverLetterMessages,
      emailMessages : window.emailMessages
    })
   
  })()
    
  const detailsElements = document.querySelectorAll('.companyContainer'); 
  detailsElements.forEach(element => {  
    element.querySelector('summary').addEventListener('click', async function() { 
      const id = parseInt(this.parentElement.id.replace('detail-', '') ); 
      const contentDiv = document.getElementById('content-' + id); 
      // console.log('clicked: ', {contentDiv})
      if (contentDiv.innerHTML == "Error...") { 
        populateCompany(contentDiv, await (await fetch('/company-view/' + id)).json());           
      }


      document.querySelectorAll('.companyContainer').forEach(element => {
          let old_id = element.id.replace('detail-', ''); 
          old_id = parseInt(old_id) 
          if(!old_id){console.log('ERROR', {element, id: element.id, old_id}) }
          if (old_id && old_id !== id && element.hasAttribute('open')){  
            console.log('element', element, 'old_id', old_id, 'newid', id)
            element.removeAttribute('open');   
            element.querySelector(`#content-${old_id}`).innerHTML =  'Error...';
          }
        });
    });
  }); 
</script>


